
### 二维数据可视化

* 颜色映射：传输函数
$$I = \text{clamp} \left( \text{round} \left( \frac{v - v_{min}}{v_{max} - v_{min}} \times (N-1) \right), 0, N-1 \right)$$

- 序列型（Sequential）： 颜色在亮度（Luminance）或饱和度上单调变化，适用于表现从低到高的连续物理量
- 发散型（Diverging）： 从中性色向两个相反的色调发散，常用于表现相对于某个基准值的正负偏差
- 分类/离散型（Qualitative/Discrete）： 使用对比鲜明的颜色区分互不相关的类别数据，而非表现数值大小

* 高度映射
* 等值线映射


### 三维数据可视化大纲

**核心区分一：渲染理念区分**

**等值面绘制**（间接体绘制）：从三维标量场中提取特定的阈值点（Iso-value），将其转化为显式的几何图元（如三角面片）再进行绘制

* 特点：数据被视为硬边界，绘制结果具有明确的表面和反射效果
* 方法：等值面绘制

**直接体渲染**（Direct Volume Rendering, DVR）：不提取任何中间几何图元，而是通过传输函数将整个三维标量场直接映射为颜色和不透明度并进行合成

* 特点：数据被视为半透明的云雾状介质
* 方法：光线投影法、掷雪球法、最大值投影、X光绘制


**核心区别二：合成顺序**

**图像空间扫描方法（反向扫描）**：对应反向图变换逻辑，即遍历屏幕像素，反查数据源

* 光线投影法：最经典的直接体渲染算法，通过传输函数将光线沿途的采样数据映射为颜色和不透明度并进行合成
（几种简化）
* X光绘制：属于直接体绘制的一种，沿着光线对所有采样点的灰度值进行累加或平均
* 最大密度投影 (MIP)：属于直接体绘制的简化变体，在光线穿过体数据的路径上，只寻找并显示最大的那个标量值
* 等值面投影绘制：属于间接体绘制在图像空间的实现，利用光线投影寻找特定的阈值点，仅在首次触碰等值面处进行着色

**First 等值面提取**

* 原理：光线一旦遇到强度大于或等于设定阈值的点就停止采样，直接返回该点的属性值
$$I(u, v) = f(p_{first}), \quad p_{first} = r(t_{min}) \text{ s.t. } f(r(t_{min})) \ge C$$

* 效果：用于提取物体的等值面，例如在医疗影像中仅渲染皮肤或骨骼的表面

**Average 平均强度投影**

* 原理：计算光线穿过数据场路径上所有采样点强度的平均值
$$I(u, v) = \frac{1}{T} \int_{0}^{T} f(r(t)) dt \approx \frac{1}{n} \sum_{i=1}^{n} f(p_i)$$
- $C_i \alpha_i$: 当前采样点贡献
- $\prod_{j=1}^{i-1} (1 - \alpha_j)$: 累积透明度（穿透率）：光线从第 $i$ 个采样点出发，在到达视点之前，必须穿过前面所有的 $i-1$ 个点 
* 效果：产生类似 X 光片的效果，反映物体内部整体的平均密度分布

**Accumulate 透明度累加**

* 原理：在合成颜色时，根据传输函数同时累加各层的不透明度和颜色贡献，通常采用从前向后或从后向前的合成顺序
$$I = \sum_{i=1}^{n} [C_i \alpha_i \prod_{j=1}^{i-1} (1 - \alpha_j)]$$

* 其中 $C_i$ 为采样点颜色，$\alpha_i$ 为不透明度
* 效果：可以使物体呈现半透明效果，令外部组织和内部结构同时可见

**Max / MIP 最大密度投影**

原理：在光线穿过的所有路径点中，仅选取并保留强度最大的那个值作为像素结果
$$I(u, v) = \max_{t \in [0, T]} \{ f(r(t)) \}$$
效果：常用于血管造影，能够突出显示高对比度的结构而不受重叠组织的干扰


**物体空间扫描方法（正向扫描）**：对应前向图变换逻辑，即遍历体素并投影到屏幕

* 掷雪球法：属于直接体渲染的一种，遍历每个体素，通过权重函数 $w_{i}(X)$ 将其贡献投影到相关的像素点上
* 移动立方体算法 (Marching Cubes)：属于等值面绘制算法，逐个处理体素，通过查找从 Case 0 到 Case 14 共 15 种基本情形的表来生成三角面片
* 移动四面体算法 (Marching Tetrahedra)：属于等值面绘制的变体，将立方体分解为四面体进行处理以消除二义性
* 分割立方体算法 (Dividing Cubes)：属于面绘制的一种改进方法，将体素细分到像素尺寸，直接生成点云而非三角形


### 二维标量场的等值线

1. 逐个处理单元格：每次只关注标量场中的一个基本网格单元    
2. 状态判定：将单元格 4 个顶点的数值 $v_i$ 与目标等值 $C$ 进行比较
3. 边交点识别：若一条边的两个端点满足 $v_{start} < C < v_{end}$ 或 $v_{end} < C < v_{start}$，则该边必然包含一个等值点
4. 线性插值计算：利用线性插值公式精确确定等值点 $P$ 在边上的位置
$$P = P_1 + \frac{C - v_1}{v_2 - v_1} \cdot (P_2 - P_1)$$
5. 连线生成：将同一单元格内生成的等值点用直线段连接，这些线段上的点数值近似等于 $C$

**拓扑案例分析**：由于单元格的每个顶点相对于 $C$ 只有两种状态（大于等于 $C$ 或小于 $C$），因此一个单元格共有 $2^4 = 16$ 种可能的顶点组合方式

经过拓扑归纳，这 16 种组合可以简化为 4 种唯一的拓扑情况：

1. 完全处于等值面之外或之内：单元格不被等值线穿过
2. 一个顶点状态不同：等值线切过一个角，产生一条线段
3. 两个顶点状态不同：等值线横穿单元格，产生一条线段
4. 二义性情况：两个相对顶点状态一致，可能产生两条分离的等值线段


### 间接体绘制 等值面提取 Marching Cubes Algorithm 

**分治法判断逻辑**

- 局部化处理：算法逐个处理体素，每个体素由 8 个顶点组成
- 顶点状态二进制化：将每个顶点 $v_i$ 的值与等值 $C$ 比较，大于等于 $C$ 记为 1，小于记为 0
- 索引生成：8 个顶点的状态组合成一个 8 位的二进制索引值，对应 $2^8 = 256$ 种状态
- 查表提取：利用该索引在预设的查找表中直接获取该体素内等值面穿过的边及其构成的三角面片拓扑

**简化为 15 种基本模式**

- 数值对称性：将体素内部和外部的状态全部翻转，所得到的等值面几何拓扑是完全一致的
- 旋转对称性：体素在三维空间中经过旋转，可以产生多个看起来不同但逻辑相同的变体
- 压缩结果：通过排除重复和对称的情况，256 种原始状态被精简为 15 种基本组合模式
* 无二义性表面：0,1,2,4,5,8,9,11,14
* 各有一个二义性表面：3，6（2种连接方式）
* 各有二个二义性表面：10，12（4种连接方式）
* 有三个二义性表面：7（8种连接方式）
* 有六个二义性表面：13（64种连接方式）
* 共93种可能的连接方式；除去对称和相同的方式，共有34种方式

**移动四面体消除歧义**


### 直接体绘制 光线投射法 Ray Casting


直接体渲染中的光线投射法是一种基于图像空间的算法，其核心是通过模拟光线在半透明介质中的物理传输过程，直接将三维标量数据场转换为二维图像。该方法不提取中间几何图元，而是通过采样、分类、光照计算和合成四个关键步骤，计算每个体素对最终像素颜色的贡献。

**阶段一：数据值分类与传输函数映射**

体分类（Volume Classification）是将原始的标量数据场 $f(i, j, k)$ 赋予光学意义的关键步骤。这一步通过传递函数（Transfer Function）实现数据值到光学属性的映射。

- 映射逻辑：传递函数决定了吸收值（不透明度 $\alpha$）和发射部分（颜色 $RGB$）。对于标量值 $s$，映射关系为：
$$s \rightarrow [R, G, B, \alpha]$$
- 维度扩展：
    1. 一维传输函数：仅基于标量值 $s$。
    2. 二维传输函数：引入梯度模 $|\nabla I|$，能够更好地区分组织边界。
    3. 三维传输函数：加入二阶导数信息，增强对特征形状的提取。
- 物理含义：发射项对应采样点发出的颜色，吸收项对应介质对光线的阻挡能力。这一步实现了从原始数据到具有物理属性的物体的转换。

 **阶段二：发出射线与等距离再采样**

对于二维屏幕上的每个像素，从视点 $\vec{O}$ 出发，沿视线方向 $\vec{D}$ 发射一条射线。

- 射线方程：$$r(t) = \vec{O} + t \cdot \vec{D}, \quad t \in [t_{near}, t_{far}]$$
- 采样策略：在射线穿过体数据的过程中，以固定步长 $\Delta t$ 进行等距离采样。
$$t = t + \Delta t$$

- 步长权衡：步长太小会导致渲染速度下降，步长太大则会产生采样走样，漏掉标量场中的微小特征。


**阶段三：采样点值的重建与插值**

采样点通常位于离散体素之间，因此需要通过插值技术获取其属性值。

- 三线性插值（Trilinear Interpolation）：利用采样点周围 8 个体素点的数值 $v_{ijk}$ 加权平均。
$$f(x, y, z) = \sum_{i=0}^1 \sum_{j=0}^1 \sum_{k=0}^1 w_{ijk} \cdot v_{ijk}$$
- 作用：通过插值重建，我们将离散的体素场转换为连续的标量场，使得采样点能获取精确的标量值、颜色和不透明度。


**阶段四：体光照模型计算**

为了增强深度感和面结构信息，需要模拟外部光源与物质的交互。

- 梯度作为法矢：在体数据中没有显式表面，通常利用梯度矢量作为法线 $N$。
$$\nabla I = (\frac{\partial I}{\partial x}, \frac{\partial I}{\partial y}, \frac{\partial I}{\partial z})$$
- 中心差分法：在正交网格中计算梯度。
$$\frac{\partial I}{\partial x} \approx \frac{f_{i+1,j,k} - f_{i-1,j,k}}{2\Delta x}$$
- Blinn-Phong 光照模型：
$$C = (k_a + k_d(N \cdot L)) \cdot C_{TF} + k_s(N \cdot H)^n$$

- 公式项含义：
    1. $N$：归一化的法线（梯度）。
    2. $L$：光线方向。
    3. $V$：视线方向。
    4. $H$：半角向量（$V$ 和 $L$ 的平均方向），用于计算镜面反射。
    5. $k_a, k_d, k_s$：环境光、漫反射、镜面反射系数。
    6. $C_{TF}$：传输函数映射得到的原始颜色。
    7. $n$：高光系数。


**阶段五：光学积分与图像合成**

合成（Compositing）是将射线路径上所有采样点的光学属性累积为最终像素值的过程。
- 原始连续光学积分公式：
$$D(r) = \int_{0}^{L} C(s) e^{-\int_{0}^{s} a(t) dt} ds$$
该公式表示光线沿路径传播时，各点发射的颜色受前面介质吸收后的累积效果。

- 离散采样近似公式：
$$D_M = \sum_{i=1}^{M} (C_i \prod_{j=1}^{i-1} (1 - a_j))$$

**赋颜色再综合：两种合成顺序**

- 从后向前（Back-to-Front）：
$$D_i = C_i + D_{i+1}(1 - a_i)$$
- 从前向后（Front-to-Back）：
$$D_i = D_{i-1} + C_i(1 - A_{i-1})$$$$A_i = A_{i-1} + (1 - A_{i-1})a_i$$其中 $A$ 是累积吸收率。这种方法支持早期射线终止（Early Ray Termination），即当累积吸收率达到 100% 时停止计算，显著提高效率。


### 直接体绘制 掷雪球法 Splatting

掷雪球法（Splatting）是一种基于物体空间扫描（Object-order）的直接体渲染算法。它通过正向投影逻辑，将三维体素的能量分布投射到屏幕上形成印记（足迹），并进行叠加合成。

 **体素的几何表达：三维重构核**

在掷雪球算法中，体素不再被视为孤立的点，而是一个具有空间连续分布的能量团。

- 几何形态：每个体素由一个三维重构核函数 $G(x, y, z)$ 表达，通常采用各向同性的高斯核
- 能量分布：以体素中心为圆心，能量向四周衰减，其数学形式为
$$G(\vec{r}) = e^{-\frac{|\vec{r} - \vec{P}_i|^2}{2\sigma^2}}$$

- 物理意义：这种表达方式保证了离散体素在投影时能够平滑过渡，避免了渲染结果出现方块状的马赛克感    

**垂直映射的坐标变换**

为了实现高效的垂直投影，需要将体素从原始的对象空间转换到与屏幕对齐的图像空间。

- 视图变换：应用一个包含旋转和平移的变换矩阵 $M$，将观察方向调整为与坐标轴（通常为 $z'$ 轴）平行
$$\begin{bmatrix} u \\ v \\ d \end{bmatrix} = M \cdot \begin{bmatrix} x \\ y \\ z \\ 1 \end{bmatrix}$$
- 垂直投影：在图像空间中，投掷方向（视线方向）垂直于投影平面 $uv$。这意味着所有体素可以沿着平行的路径直接“砸”向屏幕
- 仿射近似：对于非线性投影，需要对变换进行局部仿射近似，以保证高斯分布在变换后依然保持高斯特性

**投影印记：二维足迹函数**

体素“投掷”到屏幕上留下痕迹称为足迹（Footprint）。它是三维核函数沿视线方向积分的结果。

- 积分公式：
$$F(u, v) = \int_{-\infty}^{+\infty} G(u, v, z') dz'$$
- 物理含义：足迹函数 $F(u, v)$ 代表了体素在屏幕 $(u, v)$ 处的权重分布。中心处权重最高，向边缘逐渐减弱
- 预计算查表：在平行投影下，所有体素的足迹形状一致。算法会预先计算一个足迹查找表（Footprint Table），渲染时只需通过平移和放缩即可快速应用

**属性映射与颜色合成**

在完成足迹投影后，需要结合传输函数赋予的属性进行图像合成。

- 颜色与透明度映射：每个体素根据其标量值 $s$，通过传输函数获取颜色 $C_{voxel}$ 和不透明度 $\alpha_{voxel}$
- 像素贡献计算：体素对屏幕像素 $(i, j)$ 的实际贡献为
$$C_{pixel}(i, j) = C_{voxel} \cdot \alpha_{voxel} \cdot F(i - u_v, j - v_v)$$
- 叠加叠加逻辑：按照从后向前（BTF）或从前向后（FTB）的顺序，将不同深度的足迹进行 alpha 混合
$$D_i = C_{pixel} + D_{background}(1 - \alpha_{pixel})$$
